# Offpost - Application to interact with public entities using email

## Norwegian description of service
(kept in sync with README.md in the root directory)

Offpost - Offentlig post - er en tjeneste for å sende e-post til offentlige myndigheter.

Tjenesten baserer seg på at man lager en forespørsel til en myndighet. Denne får en unik profil med tilfeldig navn og epost. Eposten brukes for å sende e-post og å motta svar. De tilfeldige navnene baserer seg på Motorvognregisteret, så det er ekte navn men kombinasjonen av fornavn og etternavn er sannsnyligvis unik siden navene ikke er vektet.

## Key Concepts

- **Thread**: A conversation with a public entity, identified by UUID
- **Profile**: Unique identity (name + email) assigned per thread
- **Entity**: A public authority/organization that receives requests
- **IMAP Folders**: Emails organized on IMAP server, one folder per thread

## Architecture
(kept in sync with README.md in the root directory)

Offpost is mainly a PHP application running on a web server. It revolves around email threads sent to public entities.

One email thread is a conversation between the system and a public entity. Or mulitple in case of a complaint.
Connected to the thread is a profile of first name, last name and email address. This is unique for each thread.

It uses IMAP to get emails from a mail server and store them in local storage. The emails are sorted into threads
based on the to/from addresses that matches the profile of the thread.

## Technology Stack

| Component | Technology |
|-----------|------------|
| Language | PHP 8.2 |
| Web Server | Apache 2.4 |
| Database | PostgreSQL 15 |
| Email Parsing | Laminas\Mail |
| Email Sending | PHPMailer, SendGrid |
| Testing | PHPUnit 10.5 |
| Authentication | OIDC (Auth0 in prod) |
| AI | OpenAI API |
| Containers | Docker Compose |

## Components
(kept in sync with README.md in the root directory)

### Organizer
- Main program that provides client, API and JSON storage for email threads
- Creates threads and "identities" in Roundcube
- Sorts email using IMAP folders directly on the server

### Roundcube
- Webmail client using the IMAP server directly
- Email threads are stored as folders on the IMAP server
- Uses MySQL for storage

### Sendgrid (Production only)
- Used to send emails
- Handles copying to the IMAP server

### IMAP Server
- Used to store email threads
- Email threads are organized as folders on the server

### Auth Service (Development only)
- Simple authentication service for development
- Not intended for production use

### GreenMail (Development only)
- SMTP/IMAP server for development environment
- Provides email testing capabilities without external dependencies
- Configured with test accounts for local development

## Directory Structure

```
/home/user/offpost/
├── organizer/                  # Main PHP application
│   ├── Dockerfile
│   ├── src/
│   │   ├── class/             # PHP classes
│   │   │   ├── Ai/            # OpenAI integration
│   │   │   ├── Enums/         # PHP enums
│   │   │   ├── Extraction/    # Email text extraction
│   │   │   │   └── Prompts/   # LLM prompt templates
│   │   │   └── Imap/          # IMAP operations
│   │   ├── api/               # REST API endpoints
│   │   ├── system-pages/      # Scheduled task endpoints
│   │   ├── tests/             # Unit tests (PHPUnit)
│   │   ├── e2e-tests/         # Integration tests
│   │   ├── migrations/sql/    # Database migrations
│   │   ├── webroot/           # Frontend assets (CSS, JS)
│   │   └── *.php              # Page entry points
├── auth/                       # Node.js OIDC service (dev only)
├── cron-scheduler/            # Scheduled job runner
├── data/                       # Static data and test files
│   ├── entities.json          # Public entity directory
│   └── test-emails/           # Sample EML files
├── secrets/                    # Runtime secrets (gitignored)
├── docker-compose.dev.yaml    # Development environment
└── docker-compose.prod.yaml   # Production deployment
```

## Key Classes

### Core Data Models
- `Thread.php` - Thread entity with status management
- `ThreadEmail.php` - Email message model
- `ThreadEmailAttachment.php` - Attachment metadata
- `Entity.php` - Public entity directory

### Database Operations
- `Database.php` - PDO singleton connection manager
- `ThreadDatabaseOperations.php` - Thread CRUD operations
- `ThreadStatusRepository.php` - Thread status tracking

### Email Processing
- `ThreadEmailService.php` - High-level email operations
- `ThreadEmailSending.php` - Email composition and sending
- `ThreadEmailMover.php` - Email folder organization
- `ThreadEmailDatabaseSaver.php` - Persist emails to database
- `ThreadEmailClassifier.php` - Incoming vs outgoing classification

### IMAP Integration (`class/Imap/`)
- `ImapConnection.php` - Low-level IMAP protocol
- `ImapWrapper.php` - Retry logic and error handling
- `ImapFolderManager.php` - Create/manage IMAP folders
- `ImapEmailProcessor.php` - Parse emails from IMAP
- `ImapAttachmentHandler.php` - Extract attachments and PDFs

### AI/Extraction (`class/Extraction/`)
- `ThreadEmailExtractionService.php` - Create extraction records
- `ThreadEmailExtractor.php` - Orchestrate extraction types
- `ThreadEmailExtractorEmailBody.php` - Parse email text
- `ThreadEmailExtractorAttachmentPdf.php` - PDF text extraction
- `ThreadEmailExtractorPrompt.php` - LLM prompting framework

### Scheduled Tasks
- `ThreadScheduledEmailSender.php` - Process staging queue
- `ThreadScheduledEmailReceiver.php` - Fetch from inbox
- `ThreadScheduledFollowUpSender.php` - Auto-generate follow-ups

## Entry Points

### Web Pages
- `index.php` - Main dashboard with thread list
- `start-thread.php` - Create new thread with profile
- `view-thread.php` - Thread details and emails
- `api.php` - REST API router
- `auth.php` / `callback.php` - OIDC authentication

### Scheduled Tasks (`system-pages/`)
- `scheduled-email-sending.php` - Send staged emails
- `scheduled-email-receiver.php` - Fetch incoming emails
- `scheduled-imap-handling.php` - IMAP folder management
- `scheduled-email-extraction.php` - AI text extraction
- `scheduled-thread-follow-up.php` - Auto follow-up generation

## Capabilities

Main capabilities, but not limited to:
- You can read and analyze PHP code, including understanding class structures, methods, and dependencies
- You can suggest improvements to code organization and email handling logic
- You can help debug IMAP connection and email processing issues
- You can write and modify PHP unit tests
- You can help with Docker configuration and deployment

## Rules

I pledge to follow the custom instructions.

- The current working directory is project root.
- When making changes, avoid unnecessary modifications that would complicate code review (e.g. formatting, variable renaming, etc.)
- After completing work, suggest a commit command with a detailed messages explaining what and why.
- Never stage changes in git. Staging should be done by human user.
- When viewing git diffs, use git with "no-pager" parameter: git --no-pager diff
- Update relevant documentation in /docs when modifying features. Don't forget to update codebase documentation with changes.
- Keep README.md in sync with new capabilities
- Before and after any tool use, give me a confidence level (0-10) on how the tool use will help the project.

## Commands:

- Run unit tests using:
    ./organizer/src/vendor/bin/phpunit organizer/src/tests/

- Run e2e tests using:
    ./organizer/src/vendor/bin/phpunit organizer/src/e2e-tests/

- Run all tests (unit + e2e) using:
    ./organizer/src/vendor/bin/phpunit organizer/src/tests/ organizer/src/e2e-tests/

- Run system using:
    docker-compose -f docker-compose.dev.yaml up -d

- If migrations was added:
    See "restart" command below

- Complete reset of database (including recreating test data):
    docker-compose -f docker-compose.dev.yaml rm -s -f -v postgres organizer
    docker volume rm offpost_postgres_data_development
    docker-compose -f docker-compose.dev.yaml up -d
    sleep 5  # Wait for migrations to complete
    docker-compose  -f docker-compose.dev.yaml logs organizer | grep "\\[migrate\\]"

- Rebuild docker images:
    docker-compose -f docker-compose.dev.yaml down && docker-compose -f docker-compose.dev.yaml up --build -d

- Restart application/service:
    docker-compose -f docker-compose.dev.yaml down && docker-compose -f docker-compose.dev.yaml up -d

- Logs from organizer (the main container):
    docker-compose  -f docker-compose.dev.yaml logs organizer

- Check processes using:
    docker-compose -f docker-compose.dev.yaml ps

- Get into database:
    docker exec -it offpost_postgres_1 psql -U offpost -d offpost

- Reset Greenmail (clears emails and folders in mail server)
    docker-compose -f docker-compose.dev.yaml restart greenmail

## Development Services

| Service | URL | Description |
|---------|-----|-------------|
| Organizer | http://localhost:25081/ | Main PHP application |
| Roundcube | http://localhost:25080/ | Webmail client |
| Auth | http://localhost:25083/ | OIDC provider (dev) |
| Adminer | http://localhost:25084/ | Database admin |
| PHPMyAdmin | http://localhost:25082/ | MySQL admin |
| GreenMail | http://localhost:25181/ | Mail server UI |

## Database

All migrations are SQL scripts in `organizer/src/migrations/sql/`

To see the current schema for the database, read
`organizer/src/migrations/sql/99999-database-schema-after-migrations.sql`. This file is automatically updated when we make new migrations and run them.

## Security

### Sensitive Files

DO NOT read or modify:

-   .env files
-   \*_/config/secrets._
-   \*_/_.pem
-   Any file containing API keys, tokens, or credentials

### Security Practices

-   Never commit sensitive files
-   Use environment variables for secrets
-   Keep credentials out of logs and output


## Testing

Tests should be run after changes are made.

Rules:
- Assert message:
    - Give context to the assertion. But don't add messages telling the same as is asserted.
    - Asserting a size of array should always output the array in the error message. Use json_encode(..., JSON_PRETTY_PRINT).
- Structure tests as the following:
```php
// :: Setup

// :: Act

// :: Assert
```
- Tests must fail instead of skip:
    - Do NOT use markTestSkipped() or similar skip methods
    - If a test cannot run due to missing requirements, it should fail with a clear error message
    - This ensures test failures are visible and must be addressed
- Tests must be deterministic:
    - Do NOT use random values (mt_rand(), rand(), etc.)
    - Do NOT use time-based values (time(), microtime(), date(), etc.)
    - Use fixed, predictable values for test data
    - Tests should produce the same results every time they run
    - If uniqueness is needed, use sequential counters or fixed unique identifiers
- Assertions for deterministic outputs:
    - Use assertEquals instead of assertContains/assertStringContainsString when the output is deterministic
    - If the test has fixed inputs and produces predictable output, assert the exact expected value
    - Only use assertContains/assertStringContainsString when:
        - The order of elements may vary (e.g., database queries without ORDER BY)
        - The output includes non-deterministic data (e.g., timestamps, dynamic context)
        - Testing that specific content exists without requiring an exact match
    - Example: If a function generates a string from fixed dates and descriptions, use assertEquals with the full expected string

## Common Code Patterns

### Database Query Pattern
```php
$pdo = Database::getInstance()->getPdo();
$stmt = $pdo->prepare("SELECT * FROM threads WHERE id = :id");
$stmt->execute([':id' => $threadId]);
$result = $stmt->fetch(PDO::FETCH_ASSOC);
```

### IMAP Connection Pattern
```php
$wrapper = new ImapWrapper($imapConfig);
$wrapper->connect();
try {
    $emails = $wrapper->fetchEmails($folder);
} finally {
    $wrapper->disconnect();
}
```

### Error Handling Pattern
```php
try {
    $result = $service->process();
} catch (Exception $e) {
    AdminNotificationService::notifyError($e, $context);
    throw $e;
}
```

## File Naming Conventions

- Classes: `PascalCase.php` (e.g., `ThreadEmailService.php`)
- Tests: `ClassNameTest.php` (e.g., `ThreadEmailServiceTest.php`)
- Migrations: `NNN_description.sql` (e.g., `020_add_column.sql`)
- Pages: `kebab-case.php` (e.g., `view-thread.php`)
