TODO for Cline.

- [x] End-to-end testing
    - [x] Test email flow from SMTP to IMAP
    - [x] Test thread creation 
    - [x] Test thread updates
    - [x] Test attachment handling
- [x] Setup development IMAP server
    - [x] Docker container for IMAP server
    - [x] Configuration for test environment
    - [x] Test data setup scripts
- [x] Setup of production
    - [x] Domain setup
    - [x] Cloudflare setup
    - [x] Rsync to server or server auto pulling from Github?
        - Auto pull from server.
    - [x] Prod authentication setup
    - [x] Setup scripts and cron job
    - [x] Start server
    - [x] Copy over the existing data
    - [x] Migrate data to new format (script)
[x] Apache webroot is not being used. The webroot/index.php is not used. Instead the organizer/src/index.php is used.
[x] Database driver missing from docker image. Not installed or missing rebuild??


Goal: make production usable

- [ ] Move from file storage to database
    - [x] Docker compose for database
        - [x] Development
        - [x] Production
    - [x] Setup for migration scripts
    - [x] Code up new data model using database
    - [x] Migrate data
        - [x] Make script for migrating data
            docker exec -it offpost-postgres-1 psql -U offpost -d offpost
            docker exec offpost_postgres_1 psql -U offpost -d offpost -c "TRUNCATE TABLE thread_email_attachments, thread_emails, threads CASCADE;"
            rm data/threads/db-migration.json 
            docker exec offpost_organizer_1 php -d memory_limit=512M /php-frontend/migrations/migrate-data.php
        - [x] Make tool for testing the migrated data (should compare Thread from file and from DB)
            docker exec offpost_organizer_1 php -d memory_limit=512M /php-frontend/migrations/verify-migration.php
            docker exec app-organizer-1 php -d memory_limit=3500M /php-frontend/migrations/verify-migration.php 1264 1
        - [x] Run migration in test environment
        - [x] Run migration in production
            - [x] Clean up old data. Some duplicate emails present.
            - [x] Migrate data
            - [x] Verify data
    - [x] Migrated authorizations to database
    - [ ] Use new database
        - [x] Make frontpage use new database model. Make it switchable between file and db so that the resulting HTML can be compared.
        - [ ] Test in prod
        - [ ] Diff prod file vs db
    - [x] Authorization in db
        - [x] Script to grant acccess to all threads
            - [x] Make script
            - [x] Auto run in dev
            - [x] In prod docker-compose -f docker-compose.prod.yaml exec organizer php /php-frontend/grant-thread-access.php auth0|6782c7513eaab1d8116502cb
        - [x] Use authorization in db
    - [ ] Optimize database queries
        - [x] Replace N+1 queries with single optimized query
            - [x] Create single query using JOINs for threads emails and attachments
            - [ ] Add indexes for commonly queried fields
                - threads.entity_id
                - threads.archived
                - thread_emails.thread_id
                - thread_email_attachments.email_id
        - [x] Move authorization check into main query
            - [x] Modify ThreadAuthorization to work with JOIN query
            - [x] Remove authorization loop from index.php
    - [-] Implement caching system
        - [-] Add caching layer for thread data
            - [-] Setup cache with appropriate TTL
            - [-] Cache invalidation on thread updates
        - [-] Cache authorization results
            - [-] Store user thread access permissions
            - [-] Invalidate on permission changes

- [ ] Views available for public
    - [ ] Public threads visible to non authenticated users
    - [ ] Front page with information

- [ ] Update-imap - folder creation should be done in class so that logic is the same in tests and update-imap.php
- [ ] GUI for replying to threads
    - [ ] Reply form with rich text editor
    - [ ] Template system for common responses
    - [ ] Attachment upload functionality
- [ ] New thread concepts
    - Reply to thread
    - Enable notiication for replies
    - Automatic follow up

TODO - medium term:
- [ ] Automatic follow up
    - [ ] Scheduled email sending system
    - [ ] Response tracking
    - [ ] Automated reminder system
    - [ ] Configurable follow-up rules
