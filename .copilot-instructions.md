# Offpost - GitHub Copilot Custom Instructions

## Project Overview

Offpost (Offentlig post) is a Norwegian email management service for communicating with public authorities. It's a PHP application that creates unique profiles (name + email) for each thread with public entities, handles email routing via IMAP, and provides a web interface through Roundcube.

## Architecture

- **Main Component**: PHP application managing email threads to public entities
- **Email Handling**: IMAP-based email sorting and storage 
- **Web Interface**: Roundcube webmail client
- **Storage**: MySQL database + IMAP server folders
- **Development**: Docker-based setup with GreenMail for testing

### Key Components

1. **Organizer**: Main PHP program providing client, API and JSON storage
2. **Roundcube**: Webmail client using IMAP directly  
3. **IMAP Server**: Email thread storage organized as folders
4. **Sendgrid** (Production): Email sending service
5. **GreenMail** (Development): Local SMTP/IMAP testing server

## Coding Guidelines

### General Rules
- Make minimal, surgical changes - avoid unnecessary formatting/renaming
- Keep README.md and documentation in sync with code changes
- Never stage git changes automatically - let human handle staging
- Use `git --no-pager diff` when viewing diffs
- Update relevant documentation in `/docs` when modifying features

### PHP Development
- Follow existing code structure and patterns
- Write unit tests using PHPUnit for new functionality
- Structure tests with clear Setup/Act/Assert sections
- Use descriptive assertion messages with context
- For array size assertions, include the array in error messages using `json_encode(..., JSON_PRETTY_PRINT)`

### Testing Commands
```bash
# Unit tests
./organizer/src/vendor/bin/phpunit organizer/src/tests/

# E2E tests  
./organizer/src/vendor/bin/phpunit organizer/src/e2e-tests/

# All tests
./organizer/src/vendor/bin/phpunit organizer/src/tests/ organizer/src/e2e-tests/
```

### Development Environment
```bash
# Start system
docker-compose -f docker-compose.dev.yaml up -d

# Complete database reset
docker-compose -f docker-compose.dev.yaml rm -s -f -v postgres organizer
docker volume rm offpost_postgres_data_development
docker-compose -f docker-compose.dev.yaml up -d

# Rebuild containers
docker-compose -f docker-compose.dev.yaml down && docker-compose -f docker-compose.dev.yaml up --build -d

# View logs
docker-compose -f docker-compose.dev.yaml logs organizer

# Reset email server
docker-compose -f docker-compose.dev.yaml restart greenmail
```

## Database

- Current schema: `organizer/src/migrations/sql/99999-database-schema-after-migrations.sql`
- PostgreSQL database accessed via: `docker exec -it offpost_postgres_1 psql -U offpost -d offpost`
- Schema file auto-updates after migrations

## Security Guidelines

### Sensitive Files - DO NOT ACCESS:
- `.env` files
- `*/config/secrets.*`
- `*/*.pem` 
- Any files with API keys, tokens, or credentials

### Security Practices:
- Use environment variables for secrets
- Never commit sensitive data
- Keep credentials out of logs and output

## Project Context for AI Assistance

This application handles sensitive email communications with Norwegian public authorities. Code changes should:

1. **Maintain security**: Email handling must be secure and reliable
2. **Preserve functionality**: Email routing and IMAP integration are critical
3. **Follow Norwegian practices**: UI/UX should work for Norwegian users
4. **Support multi-threading**: Each public entity conversation is a separate thread
5. **Maintain data integrity**: Email storage and retrieval must be consistent

## Preferred Patterns

- Use existing PHP patterns and class structures
- Leverage Docker for development environment consistency
- Write comprehensive tests for email handling logic
- Keep email thread organization simple and maintainable
- Use IMAP folders effectively for email organization

When suggesting improvements, focus on email handling reliability, code maintainability, and security best practices.